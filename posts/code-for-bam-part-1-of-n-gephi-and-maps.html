<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2015-09-28">

<title>Ryan M Horne - Code for BAM: Part 1 of N. Gephi and Maps</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<link href="../images/favicon.ico" rel="icon">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>

  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Ryan M Horne</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../cv.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../teaching.html"> 
<span class="menu-text">Teaching</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../research.html"> 
<span class="menu-text">Research</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../digital-portfolio.html"> 
<span class="menu-text">Digital Portfolio</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/rmhorne"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://orcid.org/0000-0002-5009-3116"> 
<span class="menu-text"><img src="https://orcid.org/sites/default/files/images/orcid_16x16.png" style="vertical-align: middle;"> ORCID</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://bsky.app/profile/rmhorne.bsky.social"> 
<span class="menu-text"><img src="images/Bluesky_logo.svg" style="height: 16px; vertical-align: middle;"> Bluesky</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/RyanMHorne"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Code for BAM: Part 1 of N. Gephi and Maps</h1>
  <div class="quarto-categories">
    <div class="quarto-category">bam</div>
    <div class="quarto-category">code</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">September 28, 2015</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>This is the first in&nbsp;a series of posts where I will be detailing some of the code and development of <a href="https://bigancientmediterranean.wordpress.com/">BAM</a>.&nbsp;Some of these techniques may be old hat for some users or simple hacks, but they might be useful for anyone else who is trying to do similar work.</p>
<p>[caption id=“attachment_97” align=“alignright” width=“300”]<a href="https://ryanmatthewhorne.files.wordpress.com/2015/09/tbib-select.png"><img src="https://ryanmatthewhorne.files.wordpress.com/2015/09/tbib-select.png?w=300" class="img-fluid" alt="TBib-select"></a> Terra Biblica with both the social network graph and map displaying information on Jesus.[/caption]</p>
<p>In this post, I will detail how I got <a href="https://gephi.github.io/">Gephi</a> data (produced by&nbsp;the <a href="https://marketplace.gephi.org/plugin/sigmajs-exporter/">SigmaJs Exporter</a>) to communicate with an <a href="http://openlayers.org/two/">OpenLayers 2</a> map. When a user clicks&nbsp;on any entity in the network graph the map panel will adjust to show the locations and frequency of that entity in geographic space. At the same time, any clicks on an entity name on the map (provided by a popup) will adjust the social network graph to highlight that entity. This code is built on javascript, PHP, and a PoistGIS backend. At some point in the future BAM may transition to OpenLayers 3, but for now we are sticking with 2 as it formed the basis for À-la-Carte, <em>Digital Strabo</em>, and other digital efforts that BAM builds upon and extends.</p>
<p>For a working&nbsp;demonstration of the final result, see <a href="http://awmc.unc.edu/awmc/applications/bam/luke/">http://awmc.unc.edu/awmc/applications/bam/luke/</a>.&nbsp;All of the code mentioned in this post,&nbsp;and created for BAM, is available at:&nbsp;<a href="https://github.com/Big-Ancient-Mediterranean/BAM">https://github.com/Big-Ancient-Mediterranean/BAM</a>.</p>
<p>Step 1: <strong>Get your&nbsp;data in order!</strong></p>
<p>Before attempting any of this, you need to ensure that the entities that you are using in&nbsp;<a href="https://gephi.github.io/">Gephi</a> and the ones you have in your database have a consistent, unique ID. So, if Andrew has an id of 1234567 in&nbsp;<a href="https://gephi.github.io/">Gephi</a>, you need to associate&nbsp;1234567 with different locations, texts, etc in your database that are also related to Andrew. Failure to do so will make it&nbsp;VERY difficult, if not impossible, to get all of the different components to talk to each other.</p>
<p>Next, you actually need to build your network in&nbsp;<a href="https://gephi.github.io/">Gephi</a> and export it out. Building the network itself is beyond the scope of this post, but you need to install and familiarize yourself with the excellent&nbsp;<a href="https://marketplace.gephi.org/plugin/sigmajs-exporter/">SigmaJs Exporter</a>&nbsp;created by&nbsp;Scott Hale at the&nbsp;<a href="http://www.oii.ox.ac.uk/">Oxford Internet Institute</a>. Essentially what we are doing is taking the output of the&nbsp;<a href="https://marketplace.gephi.org/plugin/sigmajs-exporter/">SigmaJs Exporter</a>, cutting it down, and making it communicate with a dynamic, interactive map on the same webpage.</p>
<p><a href="https://ryanmatthewhorne.files.wordpress.com/2015/09/directory1.png"><img src="https://ryanmatthewhorne.files.wordpress.com/2015/09/directory1.png?w=300" class="img-fluid" alt="directory"></a>After exporting your network using the&nbsp;<a href="https://marketplace.gephi.org/plugin/sigmajs-exporter/">SigmaJs Exporter</a>, you should have a directory structure that roughly looks like the screenshot to the right. You want to upload everything but&nbsp;<em>htaccess_example</em>,&nbsp;<em>web.config</em>, and&nbsp;<em>index.html</em> to your webserver.</p>
<p>We then need to add this network to an HTML&nbsp;file that already has a map. In our case, we are modifying the code behind&nbsp;<em>Strabo Online</em> and&nbsp;<em>SNAGG</em>. I may detail how to create a map in another post, but there are plenty of resources online to get you going on a basic map.</p>
<p>We are going to mimic the functionality of the index.html file that we excluded in our own html file. First, we need to include the various javascript files and libraries used by the application:</p>
<p>[code language=“html”]</p>
<script src="js/jquery/jquery.min.js" type="text/javascript"></script>
<script src="js/sigma/sigma.min.js" type="text/javascript" language="javascript"></script>
<script src="js/sigma/sigma.parseJson.js" type="text/javascript" language="javascript"></script>
<script src="js/fancybox/jquery.fancybox.pack.js" type="text/javascript" language="javascript"></script>
<script src="js/main.js" type="text/javascript" language="javascript"></script>
<p><link rel="stylesheet" type="text/css" href="js/fancybox/jquery.fancybox.css"> <link rel="stylesheet" href="css/style.css" type="text/css" media="screen"> <link rel="stylesheet" media="screen and (max-height: 770px)" href="css/tablet.css"></p>
<p>[/code]</p>
<p>Now we need to place some divs to hold the content from our social network. These can be styled at your leisure.</p>
<p>[code language=“html”]</p>
<div id="socialNetContainer" class="socialNetContainer" style="padding-left: 1%;padding-right: 1%;">
<div class="sigma-parent">
<div id="sigma-canvas" class="sigma-expand">
<div id="attributepane" style="z-index:9994">
<div class="text">
<div class="left-close returntext" title="Close">
<div class="c cf">
<span>Return to the full network</span>
</div>
</div>
<div class="nodeattributes">
<div class="name">

</div>
<div class="data">

</div>
<div class="p">
Connections:
</div>
<div class="link">
<ul>
</ul>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<p>[/code]</p>
<p>Now that we have all the functionality of the&nbsp;<a href="https://marketplace.gephi.org/plugin/sigmajs-exporter/">SigmaJs Exporter</a>&nbsp;in our map, we need to make the components talk to each other.&nbsp;First, we need to identify what node is active on the sigma.js div, and use that information to select the appropriate data for our map. The function&nbsp;<em>nodeActive</em> in SigmaJs identifies what / when a node is active - so we will extend this to pass that information to a variable (for a more detailed explanation on how to extend a javascript function, see&nbsp;<a href="http://coreymaynard.com/blog/extending-a-javascript-function/">http://coreymaynard.com/blog/extending-a-javascript-function/</a>).</p>
<p>We are also going to create a separate function to deal with adjusting the map itself, called tBibPersonConnections, which will be called in our new, extended function:</p>
<p>[code language=“javascript”] (function() { //first copy the old function in the new one var old_nodeActive = nodeActive;</p>
<p>//new function with the same name as the old one - this overrides the old function nodeActive = function() {</p>
<p>//we are going to build the map from the person_id that is called from the node // this is a separate function that will be explained below tBibPersonConnections(arguments[0], tBibPeoplelayer); activePerson = arguments[0];</p>
<p>// Calls the original function\ var result = old_nodeActive.apply(this, arguments);</p>
<p>// now return the result return result; } })(); [/code]</p>
<p>tBibPersonConnections is where the work really happens. Lets examine this function&nbsp;slowly.</p>
<p>[code language=“javascript”]</p>
<p>function tBibPersonConnections(personNameChoice, tBibPeoplelayer) { var dataStringForFeature =‘pid=’ +personNameChoice +‘&amp;amp;amp;amp;amp;amp;start=0’; tBibPeoplelayer.destroyFeatures(); tBibfeaturesOnMap =[];</p>
<p>$.ajax({ dataType: “json”, type:‘GET’, data:dataStringForFeature, url:‘tbib_mapmaker.php’, success:function(dataJson) { for (var i = 0; i &amp;amp;amp;amp;amp;lt; dataJson.features.length; i++){ var untransformed_feature = geojson_format.read(dataJson, “FeatureCollection”); //for some reason this is going into an array. Going to hardcode for now for (var j = 0; j &amp;amp;amp;amp;amp;lt; dataJson.features.length; j++){ if (tBibfeaturesOnMap.indexOf(untransformed_feature[j].attributes.pid) &amp;amp;amp;amp;amp;lt; 0){ tBibPeoplelayer.addFeatures(untransformed_feature[j]); tBibfeaturesOnMap.push(untransformed_feature[j].attributes.pid); } } tBibPeoplelayer.refresh({force:true}); } }, error: function (xhr, ajaxOptions, thrownError) { alert(xhr.responseText); } });</p>
<p>} [/code]</p>
<p>The function takes the ID of the person selected and layer that houses all of the feature information as arguments.</p>
<p>The first thing we do is create&nbsp;parameters for the PHP file that will return all of the place / feature information that is associated with an individual person. Do not worry about the “start” parameter for now, as it is only used when resetting the map to an initial state. The lines</p>
<p>tBibPeoplelayer.destroyFeatures(); tBibfeaturesOnMap =[];</p>
<p>first clear the map layer of all features, and then sets up an array to hold all of the new features that we will be adding to the map.</p>
<p>The AJAX call to tbib_mapmaker.php actually queries our database, and returns each feature that is associated with an individual, the number of times&nbsp;the individual is mentioned with the feature, and the geographic location of the feature.&nbsp;While the actual sql calls are specific to this application / database, I will show what we are doing for combining Pleiades&nbsp;data, BAM data, and the map:</p>
<p>[code language=“PHP”] <span class="math inline">\(query = "select pplaces.title, count(pplaces.title), max (pplaces.id) as pleaides\_id, ST\_AsGeoJSON(ST\_Transform(max(pplaces.the\_geom), 3857)) as geom from pplaces JOIN tbib\_pleiades ON pplaces.id = tbib\_pleiades.pleiades\_id JOIN tbib\_network ON tbib\_pleiades.verse = tbib\_network.reference where character\_1 = '\)</span>pidParam’ or character_2 = ‘$pidParam’ GROUP BY pplaces.title”; [/code]</p>
<p>We are interested in every occurrence of an individual, so we do not care if the person is the target or the source. Our tbib_network table is <em><strong>exactly</strong></em> the same as the table used to build our Gephi network, and all people are assigned&nbsp;a unique ID that remains consistent across tables.</p>
<p>At the end of the .php file, all of the results are returned in json format:</p>
<p>[code language=“PHP”] //make a geojson object while(<span class="math inline">\(row =pg\_fetch\_assoc(\)</span>qry_result)){ //resize for map <span class="math inline">\(sizeForMap = ((\)</span>row[count] / 10) + 1);</p>
<p>//arrange for map <span class="math inline">\(arr\[\] = array( "type" =&gt; "Feature", "geometry" =&gt; json\_decode(\)</span>row[geom]), “properties” =&gt; array( “title” =&gt;<span class="math inline">\(row\[title\], "count" =&gt;\)</span>sizeForMap, “pid” =&gt; $row[pleaides_id] ), ); } //encode into geojson <span class="math inline">\(geojson = '{"type":"FeatureCollection","features":'.json\_encode(\)</span>arr).’}’; echo $geojson; ?&gt; [/code]</p>
<p>In the future, this database work will be mirrored&nbsp;by static json files, to allow for the easy export / import of BAM material.</p>
<p>When the PHP file returns a json string, the function then pulls it apart, creates new OpenLayers features, and then adds them to the map:</p>
<p>[code language=“javascript”] success:function(dataJson) { for (var i = 0; i &lt; dataJson.features.length; i++){ var untransformed_feature = geojson_format.read(dataJson, “FeatureCollection”); for (var j = 0; j &lt; dataJson.features.length; j++){ if (tBibfeaturesOnMap.indexOf(untransformed_feature[j].attributes.pid) &lt; 0){ tBibPeoplelayer.addFeatures(untransformed_feature[j]); tBibfeaturesOnMap.push(untransformed_feature[j].attributes.pid); } } tBibPeoplelayer.refresh({force:true}); } }, [/code]</p>
<p>The result is a layer that changes depending on what person is clicked.</p>
<p>[caption id=“attachment_131” align=“alignright” width=“300”]<a href="https://ryanmatthewhorne.files.wordpress.com/2015/09/selected-location.png"><img src="https://ryanmatthewhorne.files.wordpress.com/2015/09/selected-location.png?w=300" class="img-fluid" alt="A user selected popup"></a> A user selected popup[/caption]</p>
<p>That is great for changing the map, but what about changing the nodes on the network graph for when an individual is selected on the map?</p>
<p>As we are displaying people names, not ID&nbsp;as clickable information in our popups, we need a way to translate the names to the IDs used by SigmaJs. This is simply a trivial php script that looks up an ID from a name table. Once the ID is returned, we simply activate the node with a call to the&nbsp;<em>nodeActive</em> function that we extended earlier and to our&nbsp;tBibPersonConnections function.</p>
<p>First, however, we have to listen for the event where the popup on the map is clicked:</p>
<p>[code language=“javascript”]</p>
<p>//this is the popup listner</p>
<p>$(‘#popupSnagTable tbody’).on( ‘click’, ‘td’, function () { //now to start stripping out to what we need var columnName = <span class="math inline">\(('#popupSnagTable thead tr th').eq(\)</span>(this).index()).html().trim(); if (columnName == ‘Reference’)</p>
<p>{ var ActiveRef = <span class="math inline">\((this).html().trim(); ActiveRef = ActiveRef.replace('Lk ',''); var ActiveRefSpilt = ActiveRef.split(":"); activeChapter = ActiveRefSpilt\[0\]; activeVerse = ActiveRefSpilt\[1\]; getPerseusText(\)</span>(this).html().trim(), 0); } //if the user clicks on a name, then we use this to make an ajax call if ((columnName == ‘Entity 1’) || (columnName == ‘Entity 2’)){ var personNameChoice = $(this).html().trim();</p>
<p>var dataString = ‘pid=’+personNameChoice;</p>
<p>$.ajax( { type:‘GET’, data:dataString, url:‘bamIdFromNum.php’, success:function(data2)</p>
<p>{</p>
<p>//from the sigma.js gephi instance</p>
<p>nodeActive(data2);</p>
<p>//now to add all of the places the entity is on the map. Searching by ID</p>
<p>tBibPersonConnections(data2, tBibPeoplelayer);</p>
<p>}</p>
<p>});</p>
<p>[/code]</p>
<p>That is all there is to it - just a few listeners and a variable or two. There may be more efficient ways of doing this, but all the components are talking to each other!</p>



<p><br><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"></a><br>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>