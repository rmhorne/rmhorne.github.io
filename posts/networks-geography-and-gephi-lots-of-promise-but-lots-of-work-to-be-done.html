<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.4.553">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="dcterms.date" content="2015-10-07">

<title>Ryan M Horne - Networks, Geography, and Gephi: Lots of Promise, but Lots of Work to be Done</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
</style>


<script src="../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../site_libs/clipboard/clipboard.min.js"></script>
<script src="../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../site_libs/quarto-search/fuse.min.js"></script>
<script src="../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../">
<script src="../site_libs/quarto-html/quarto.js"></script>
<script src="../site_libs/quarto-html/popper.min.js"></script>
<script src="../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../site_libs/quarto-html/anchor.min.js"></script>
<link href="../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../site_libs/quarto-html/quarto-syntax-highlighting.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../site_libs/bootstrap/bootstrap.min.css" rel="stylesheet" id="quarto-bootstrap" data-mode="light">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>


<link rel="stylesheet" href="../styles.css">
</head>

<body class="nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../index.html">
    <span class="navbar-title">Ryan M Horne</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../cv.html"> 
<span class="menu-text">CV</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../posts.html"> 
<span class="menu-text">Posts</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../digital-portfolio.html"> 
<span class="menu-text">Digital Portfolio</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/rmhorne"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="https://orcid.org/0000-0002-5009-3116"> 
<span class="menu-text">https://orcid.org/0000-0002-5009-3116</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://hcommons.social/web/@rmhorne"> <i class="bi bi-mastodon" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com/RyanMHorne"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
          <div class="quarto-navbar-tools">
</div>
      </div> <!-- /container-fluid -->
    </nav>
</header>
<!-- content -->
<div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-article page-navbar">
<!-- sidebar -->
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar">
        
    </div>
<!-- main -->
<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Networks, Geography, and Gephi: Lots of Promise, but Lots of Work to be Done</h1>
  <div class="quarto-categories">
    <div class="quarto-category">maps</div>
    <div class="quarto-category">social-networks</div>
  </div>
  </div>



<div class="quarto-title-meta">

    
    <div>
    <div class="quarto-title-meta-heading">Published</div>
    <div class="quarto-title-meta-contents">
      <p class="date">October 7, 2015</p>
    </div>
  </div>
  
    
  </div>
  


</header>


<p>This post will outline some of my efforts to bring social networks into dialog with geography. Although I have found some interesting plugins and hacks, the results still leave something to be desired.</p>
<p><a href="https://ryanmatthewhorne.files.wordpress.com/2015/10/screen-shot-2015-10-07-at-1-40-46-pm.png"></a><a href="http://awmc.unc.edu/awmc/applications/snagg_test/"><img src="https://ryanmatthewhorne.files.wordpress.com/2015/10/screen-shot-2015-10-07-at-1-40-46-pm.png?w=300" class="img-fluid" alt="Screen Shot 2015-10-07 at 1.40.46 PM"></a>To provide some background: From my dissertation I have a nice, <a href="http://awmc.unc.edu/awmc/applications/snagg_test/">interactive map of all garrisons</a> (<em>phrourai</em>, in orange), and garrison commanders (<em>phrourarchoi</em>, in white) from all of Greek sources&nbsp;up to the mid second century C.E.&nbsp;This is all nicely georeferenced, linked to other projects such as <a href="http://pleiades.stoa.org/">Pleiades</a> and <a href="http://pelagios-project.blogspot.co.uk/">Pelagios</a>, and serves its purpose pretty well. However, this provides the location and frequency of garrisons and commanders, and does not really show the social network that developed between commanders, monarchs, and communities. I could perhaps use a clustering strategy to create dynamic markers around specific points, but that seems to be a very unwieldy solution.</p>
<p>Strictly speaking, by modeling people (<em>phrourarchoi</em>, monarchs) with places and abstract communities I am moving beyond a <a href="https://www.cs.cornell.edu/home/kleinber/networks-book/networks-book-ch13.pdf"><em>social network</em> and instead looking at an <em>information network</em></a>, as I am interested in a number of different connections (social, geographic, ideological) that are not traditionally associated with social network analysis.</p>
<p>The first step to get all of my data into <a href="https://gephi.github.io/">Gephi</a>, assign different “types” to my nodes (in my case people, offices, places, <em>phrourarchoi</em>). I then created a network map, ran statistics, assigned the node size based on degree, and ran a <em>force atlas</em> layout. At the same time I also color coded the network based on type. This is all pretty basic&nbsp;<a href="https://gephi.github.io/">Gephi</a> use so far, and produced a perfectly serviceable network graph.</p>
<p>[caption id=“attachment_186” align=“aligncenter” width=“300”]<a href="https://ryanmatthewhorne.files.wordpress.com/2015/10/degree.png"><img src="https://ryanmatthewhorne.files.wordpress.com/2015/10/degree.png?w=300" class="img-fluid" alt="degree"></a> First graph. Pretty basic and serviceable.[/caption]</p>
<p>Now it was time to experiment with different types of ranking. <a href="https://en.wikipedia.org/wiki/Betweenness_centrality">Betweenness centrality</a>, or the measure of a node’s influence, led to an interesting difference in graphs:</p>
<p>[caption id=“attachment_187” align=“aligncenter” width=“300”]<a href="https://ryanmatthewhorne.files.wordpress.com/2015/10/untitled.png"><img src="https://ryanmatthewhorne.files.wordpress.com/2015/10/untitled.png?w=300" class="img-fluid" alt="Untitled"></a> Betweenness Graph. Note the increased importance of individuals.[/caption]</p>
<p>However, this result is somewhat meaningless, as my graph covers a period from the 400s BCE to the 100s CE. Despite any of his wishes to the contrary,&nbsp;<a href="https://en.wikipedia.org/wiki/Ptolemy_VIII_Physcon">Ptolemy VIII</a> did not live forever, yet he is the unquestioned central authority of this graph. All of the other Egyptian monarchs also score highly, underlining their importance in the communications and relationships between different&nbsp;<em>phrourarchoi.</em> This is an interesting yet hardly unsurprising finding - a good portion of the surviving data on&nbsp;<em>phroruarchoi</em>&nbsp;originates from <a href="https://en.wikipedia.org/wiki/Ptolemaic_Kingdom">Ptolemaic Egypt</a>, which may&nbsp;inflate the relative importance of the dynasty in this kind of analysis. What this map does show is the enormous influence of individuals - most of whom were not&nbsp;<em>phrourarchoi</em> themselves.</p>
<p>However, I am interested in garrisons as a sustained phenomena across several centuries, so I want to get back to the importance of location and geography on garrisons. In other words: Where are the most important locations for&nbsp;<em>phrourarchoi,</em> and how do those relate to one another?</p>
<p>Running an <em><a href="http://faculty.ucr.edu/~hanneman/nettext/C10_Centrality.html#Eigenvector">Eigenvector Centrality</a></em> measurement&nbsp;produces a graph that somewhat mimics my original map, with physical locations, not people as the most significant authorities. This gives a better impression of what I am looking for - the centrality of a node relative to the whole network, which in my case privileges locations, which often serve as a bridge between different populations of nodes.</p>
<p>[caption id=“attachment_189” align=“aligncenter” width=“300”]<a href="https://ryanmatthewhorne.files.wordpress.com/2015/10/egienvector.png"><img src="https://ryanmatthewhorne.files.wordpress.com/2015/10/egienvector.png?w=300" class="img-fluid" alt="egienvector"></a> Eigenvector Centrality[/caption]</p>
<p>To me this is an interesting graph: It shows the importance of locations, while still highlighting important individuals.&nbsp;Now that I have this graph, I would love to place it on a map. I actually have coordinates for all of the locations, so a simple use of the <a href="https://gephi.github.io/">Gephi</a> <a href="https://marketplace.gephi.org/plugin/geolayout/">GeoLayout</a> plugin puts all of my identified places in a rough geographic&nbsp;layout.</p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><a href="https://ryanmatthewhorne.files.wordpress.com/2015/10/screen-shot-2015-10-07-at-12-48-40-pm.png"><img src="https://ryanmatthewhorne.files.wordpress.com/2015/10/screen-shot-2015-10-07-at-12-48-40-pm.png?w=300" class="img-fluid figure-img" alt="Screen Shot 2015-10-07 at 12.48.40 PM"></a></p>
<figcaption>Screen Shot 2015-10-07 at 12.48.40 PM</figcaption>
</figure>
</div>
<p>From here I simply fixed the location of the places, then ran some other layouts to try and make a coherent graph of people and offices that did not have a specific geographic value.The results were generally less than satisfying. The individuals in my dataset are not assigned coordinates because it would make little sense to do so - some&nbsp;<em>phroruarchoi</em> served in multiple locations, and almost all imperial&nbsp;<em>phrourarchoi</em> served outside their place of origin, were buried somewhere else, possibly lived in yet another location, etc.</p>
<p>[caption id=“attachment_192” align=“alignleft” width=“300”]<a href="https://ryanmatthewhorne.files.wordpress.com/2015/10/geo.png"><img src="https://ryanmatthewhorne.files.wordpress.com/2015/10/geo.png?w=300" class="img-fluid" alt="geo"></a> Force Atlas combined with <a href="https://marketplace.gephi.org/plugin/geolayout/">GeoLayout</a>[/caption]</p>
<p>[caption id=“attachment_193” align=“alignright” width=“300”]<a href="https://ryanmatthewhorne.files.wordpress.com/2015/10/circle.png"><img src="https://ryanmatthewhorne.files.wordpress.com/2015/10/circle.png?w=300" class="img-fluid" alt="circle"></a> Force atlas and Fruchterman-Reingold[/caption]</p>
<p>[caption id=“attachment_195” align=“aligncenter” width=“300”]<a href="https://ryanmatthewhorne.files.wordpress.com/2015/10/geo-attempr.png"><img src="https://ryanmatthewhorne.files.wordpress.com/2015/10/geo-attempr.png?w=300" class="img-fluid" alt="geo-attempr"></a> Adjusting the size of the nodes and running force atlas eventually produced &nbsp;a result that looks more comprehensible, if a bit small.[/caption]</p>
<p>From this step, I thought I would try out some <a href="https://gephi.github.io/">Gephi</a> plugins to push my data into a format I could drop onto a map. Only a very small percentage of my nodes actually contain geographic information, so the <a href="https://marketplace.gephi.org/plugin/exporttoearth/">ExportToEarth</a>&nbsp;plugin was not going to help. My first attempt at pushing out a shapefile using&nbsp;<a href="https://marketplace.gephi.org/plugin/export-to-shp/">Export to SHP</a> initially looked like a success in <a href="http://www.qgis.org/en/site/">QGIS</a>:</p>
<p>[caption id=“attachment_196” align=“aligncenter” width=“300”]<a href="https://ryanmatthewhorne.files.wordpress.com/2015/10/screen-shot-2015-10-07-at-1-43-16-pm.png"><img src="https://ryanmatthewhorne.files.wordpress.com/2015/10/screen-shot-2015-10-07-at-1-43-16-pm.png?w=300" class="img-fluid" alt="Screen Shot 2015-10-07 at 1.43.16 PM"></a> This looks promising…[/caption]</p>
<p>So, I decided to throw in some background, and that is when the trouble started. <a href="http://www.qgis.org/en/site/">QGIS</a> does a good job of transforming coordinates, but this was just messy (and not to mention wrong - there certainly were no <em>phrourarchoi</em> in Antarctica!)</p>
<p>[caption id=“attachment_197” align=“aligncenter” width=“300”]<a href="https://ryanmatthewhorne.files.wordpress.com/2015/10/screen-shot-2015-10-07-at-1-35-59-pm.png"><img src="https://ryanmatthewhorne.files.wordpress.com/2015/10/screen-shot-2015-10-07-at-1-35-59-pm.png?w=300" class="img-fluid" alt="Screen Shot 2015-10-07 at 1.35.59 PM"></a> Note how the nodes are now literally all over the map.[/caption]</p>
<p>So, what happened? If you do not have coordinates already explicitly assigned to your data,&nbsp;<a href="https://marketplace.gephi.org/plugin/export-to-shp/">Export to SHP</a>&nbsp;actually does not use “geographic” coordinates, and instead uses, in the words of the&nbsp;plugin, “fake geography – that is the current position of the nodes in the Gephi layout”. My thought that this position would line up with correct coordinates from<a href="https://marketplace.gephi.org/plugin/geolayout/">GeoLayout</a> were false -<a href="https://marketplace.gephi.org/plugin/export-to-shp/">Export to SHP</a> treats the middle of the map as an origin point (instead of using whatever geographic data is present), and as such it does not match with any projection in&nbsp;<a href="http://www.qgis.org/en/site/">QGIS</a>.</p>
<p>This is a bit of a let down. It seems that all of mapping plugins in <a href="https://gephi.github.io/">Gephi</a> need for *<em><strong>ALL</strong></em>* of the nodes to have geographic information already baked in, or they will not export a geographically accurate map. This does make some sense, but it would be nice if you could use&nbsp;<a href="https://marketplace.gephi.org/plugin/geolayout/">GeoLayout</a> to place nodes with actual geographic data, then use force atlas or some other layout to produce a graph, and finally&nbsp;use the location of those nodes as coordinates. In other words, the location of nodes on the graph that have no actual geographic data of their own are located relative to nodes that do have geographic data. I tried the <a href="https://marketplace.gephi.org/plugin/sigmajs-exporter/">Sigmajs exporter</a>, but the json object also does not use real coordinates, as seen in the fragment below (&nbsp;<em>lng</em> and <em>lat</em> are the real-world&nbsp;coordinates, while <em>x</em> and&nbsp;<em>y</em> are used by <a href="http://sigmajs.org/">SigmaJS</a>):</p>
<p>[code language=“javascript”]</p>
<p>“label”:“Priene/‘Lince’?”, “x”:-22.65546226501465, “y”:32.66741943359375, “id”:“Pl_599905”, “attributes”:{ … “lng”:“27.297566084106442”, “lat”:“37.659724652604169”, …}, [/code]</p>
<p>So, is there a way around this?</p>
<p>Short of writing a new plugin to do so, it looks like <a href="https://gephi.github.io/">Gephi</a> is simply missing the functionality of assigning geographic points to nodes that do not already have that information, then exporting that graph in a way that makes sense to mapping software. I could export an image and georeference that, but that will not provide the functionality I am looking for either.</p>
<p>What I would like is for a graph produced by <a href="https://gephi.github.io/">Gephi</a> to use coordinates for nodes that have them, and make real world coordinates for nodes that do not. This map could then be placed on <a href="http://leafletjs.com/">Leaflet</a> / <a href="http://openlayers.org/">OpenLayers</a> / whatever map, providing a level of interaction&nbsp;beyond a static image. As it is impracticable to duplicate the functionality (especially the statistical tools and layouts) of <a href="https://gephi.github.io/">Gephi</a> in a mapping application, this strikes me as something that would be very valuable to visualization and study.</p>
<p>My next idea is to see if <a href="https://www.r-project.org/">R</a> has something close to what I want, which I will detail in a future post.</p>



<p><br><a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/"><img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-sa/4.0/88x31.png"></a><br>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-sa/4.0/">Creative Commons Attribution-ShareAlike 4.0 International License</a>.</p></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button', {
    text: function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
    }
  });
  clipboard.on('success', function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  });
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      // TODO in 1.5, we should make sure this works without a callout special case
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>